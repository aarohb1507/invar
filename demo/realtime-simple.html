<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Invar SSE Demo</title>
  <style>
    body{font-family:system-ui,Arial;margin:16px}
    #log{white-space:pre-wrap;border:1px solid #ddd;padding:12px;max-height:60vh;overflow:auto}
    .meta{color:#666;font-size:0.9em}
  </style>
</head>
<body>
  <h3>Invar SSE Live Demo</h3>
  <div class="meta">Open this while the server is running and the sample publisher is sending metrics.</div>
  <div id="log">Connectingâ€¦</div>

  <script>
    const logEl = document.getElementById('log');
    function append(v){ logEl.textContent = v + "\n" + logEl.textContent; }

    // If SSE endpoint is cookie-protected, call session endpoint first (same-origin):
    // fetch('/v1/auth/session', { method: 'POST', credentials: 'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ apiKey: 'YOUR_KEY' }) });

    const es = new EventSource('/v1/metrics/live', { withCredentials: true });
    es.onopen = () => append('[open] connected to /v1/metrics/live');
    es.onerror = (e) => append('[error] ' + (e?.message || 'connection error'));
    es.onmessage = (e) => {
      try {
        const p = JSON.parse(e.data);
        append(`[event] ${new Date(p.timestamp*1000).toISOString()} ${p.server} ${p.metric}=${p.value}`);
      } catch {
        append('[event] ' + e.data);
      }
    };
  </script>
</body>
</html>